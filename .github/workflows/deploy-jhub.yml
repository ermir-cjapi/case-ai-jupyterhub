name: Deploy JupyterHub Lab

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: lab

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Set environment variables
        run: |
          echo "NAMESPACE=jupyterhub-test" >> $GITHUB_ENV
          echo "VALUES_FILE=infra/jupyterhub/values-lab-cloudflare.yaml" >> $GITHUB_ENV
          echo "RELEASE_NAME=jhub-lab" >> $GITHUB_ENV

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy JupyterHub
        run: |
          export NAMESPACE=${{ env.NAMESPACE }}
          export VALUES_FILE=${{ env.VALUES_FILE }}
          export RELEASE_NAME=${{ env.RELEASE_NAME }}
          ./scripts/deploy-lab-cloudflare.sh

      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=Ready pod \
            -l app=jupyterhub \
            -n ${{ env.NAMESPACE }} \
            --timeout=600s

      - name: Deployment summary
        run: |
          echo "### Lab Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Lab (Cloudflare)" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ env.RELEASE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Pods Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

